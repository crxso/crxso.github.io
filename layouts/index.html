{{ define "main" }}
    
    {{/* CUSTOM CONTENT INJECTION: This renders content/_index.md */}}
    {{ with .Content }}
    <section class="article-list custom-homepage-content" style="padding-top: 0; padding-bottom: 0;">
        {{ . }}
    </section>
    {{ end }}
    
    {{- $subsections := .Sections -}}
    {{- $pages := .Pages | complement $subsections -}}
    
    {{- if eq (len $pages) 0 -}}
        {{- $pages = $subsections -}}
        {{- $subsections = slice -}}
    {{- end -}}

    {{- with $subsections -}}
        <aside>
            <h2 class="section-title">{{ T "list.subsection" (len $subsections) }}</h2>
            <div class="subsection-list">
                <div class="article-list--tile">
                    {{ range . }}
                        {{ partial "article-list/tile" (dict "context" . "size" "250x150" "Type" "section") }}
                    {{ end }}
                </div>
            </div>
        </aside>
    {{- end -}}
    
    {{- $paginator := .Paginate $pages -}}
    
    <section class="article-list" style="margin-top: 0px;">
        {{ range $paginator.Pages }}
            {{ partial "article-list/default" . }}
        {{ end }}
    </section>

    {{- partial "pagination.html" . -}}

    {{/* ------------------------------------------------------------- */}}
    {{/* GITHUB GRAPH INJECTION */}}
    {{/* ------------------------------------------------------------- */}}

    <style>
        /* * FIX: This CSS filter inverts the image colors ONLY when the site is in dark mode.
        * It turns the white empty boxes black and adjusts the hue for readability.
        */
        :root[data-scheme="dark"] .github-graph-img {
            filter: invert(1) brightness(1.3) hue-rotate(315deg);
        }
    </style>
    
    <div id="github-graph-scroll-wrapper" style="
        overflow-x: auto; 
        -webkit-overflow-scrolling: touch;
        margin: 40px auto 40px; 
        padding-top: 20px; 
        max-width: 100%;
        border-top: 1px solid var(--card-separator-color, #30363D);
        padding-left: 10px;
        padding-right: 10px;
    ">
        <div style="text-align: center; width: max-content; margin: 0 auto;">
            <a href="https://github.com/crxso" target="_blank" title="View my GitHub Profile">
              <img id="github-contributions-graph" 
                   src=""
                   alt="crxso's GitHub Contributions" 
                   class="github-graph-img" style="
                        max-width: 100%; 
                        height: auto; 
                        border-radius: 0px; 
                        box-shadow: 0 4px 12px rgba(254, 0, 0, 0.1);
                        margin-bottom: 20px; 
                        transform: scale(1.02);
                        transform-origin: center;
                   ">
            </a>
        </div>
    </div>
    
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const wrapper = document.getElementById('github-graph-scroll-wrapper');
            const graphImg = document.getElementById('github-contributions-graph');
            const root = document.querySelector(':root');

            // Set the URL to the custom red color for Light Mode, as per your previous choice.
            // Dark Mode inversion is handled by CSS filter applied to this image.
            const baseSrc = 'https://ghchart.rshah.org/ce0000/crxso'; 
            
            function updateGraphSrc() {
                // Use a cache buster to ensure the image loads and the CSS filter is applied on every view/toggle
                const cacheBuster = Date.now();
                graphImg.src = `${baseSrc}?v=${cacheBuster}`; 
            }

            // Initial load
            if (graphImg && root) {
                updateGraphSrc();
            }

            // Observe changes to the data-scheme attribute to force a reload 
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.type === 'attributes' && mutation.attributeName === 'data-scheme') {
                        // Forcing a src update triggers a re-render, ensuring the CSS filter applies correctly.
                        updateGraphSrc();
                    }
                });
            });

            if (root) {
                observer.observe(root, { attributes: true });
            }

            // 2. Scrolling Logic (retained)
            if (wrapper) {
                setTimeout(() => {
                    wrapper.scrollLeft = wrapper.scrollWidth;
                }, 100); 
            }
        });
    </script>
    
    {{ partialCached "footer/footer" . }}
{{ end }}

{{ define "right-sidebar" }}
    {{ partial "sidebar/right.html" (dict "Context" . "Scope" "homepage") }}
{{ end }}